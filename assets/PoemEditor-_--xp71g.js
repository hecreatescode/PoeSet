import{c as h,r as a,b as fe,u as be,d as xe,g as we,n as ee,j as e,p as ke}from"./index-BVxns9Ap.js";import{X as H}from"./x--fa1NlzU.js";import{E as ve,S as je}from"./save-77M5NSrY.js";import{T as Se}from"./tag-jf3Neaz5.js";import{P as te}from"./plus-C6xuWks6.js";const ze=[["path",{d:"M6 12h9a4 4 0 0 1 0 8H7a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h7a4 4 0 0 1 0 8",key:"mg9rjx"}]],Ce=h("bold",ze);const Me=[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]],Ne=h("calendar",Me);const Ee=[["path",{d:"M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49",key:"ct8e1f"}],["path",{d:"M14.084 14.158a3 3 0 0 1-4.242-4.242",key:"151rxh"}],["path",{d:"M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143",key:"13bj9a"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]],Te=h("eye-off",Ee);const $e=[["line",{x1:"19",x2:"10",y1:"4",y2:"4",key:"15jd3p"}],["line",{x1:"14",x2:"5",y1:"20",y2:"20",key:"bu0au3"}],["line",{x1:"15",x2:"9",y1:"4",y2:"20",key:"uljnxc"}]],Ie=h("italic",$e);const _e=[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]],Pe=h("lock",_e);const Ae=[["path",{d:"M12 19v3",key:"npa21l"}],["path",{d:"M15 9.34V5a3 3 0 0 0-5.68-1.33",key:"1gzdoj"}],["path",{d:"M16.95 16.95A7 7 0 0 1 5 12v-2",key:"cqa7eg"}],["path",{d:"M18.89 13.23A7 7 0 0 0 19 12v-2",key:"16hl24"}],["path",{d:"m2 2 20 20",key:"1ooewy"}],["path",{d:"M9 9v3a3 3 0 0 0 5.12 2.12",key:"r2i35w"}]],ne=h("mic-off",Ae);const De=[["path",{d:"M12 19v3",key:"npa21l"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["rect",{x:"9",y:"2",width:"6",height:"13",rx:"3",key:"s6n7sd"}]],Ke=h("mic",De);const Re=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 14s1.5 2 4 2 4-2 4-2",key:"1y1vjs"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]],Be=h("smile",Re);const Le=[["path",{d:"M6 4v6a6 6 0 0 0 12 0V4",key:"9kb039"}],["line",{x1:"4",x2:"20",y1:"20",y2:"20",key:"nun2al"}]],Oe=h("underline",Le),re=["happy","sad","neutral","inspired","melancholic","excited","calm","anxious"],Fe=c=>{a.useEffect(()=>{const d=r=>{for(const i of c){const l=r.key.toLowerCase()===i.key.toLowerCase(),f=i.ctrlKey===void 0||r.ctrlKey===i.ctrlKey,s=i.shiftKey===void 0||r.shiftKey===i.shiftKey,m=i.altKey===void 0||r.altKey===i.altKey,u=i.metaKey===void 0||r.metaKey===i.metaKey;if(l&&f&&s&&m&&u){const S=r.target;if((S.tagName==="INPUT"||S.tagName==="TEXTAREA"||S.isContentEditable)&&r.key!=="Escape")continue;r.preventDefault(),i.callback(r);break}}};return document.addEventListener("keydown",d),()=>document.removeEventListener("keydown",d)},[c])};class He{static parse(d){let r=d;return r=r.replace(/^### (.*$)/gim,"<h3>$1</h3>"),r=r.replace(/^## (.*$)/gim,"<h2>$1</h2>"),r=r.replace(/^# (.*$)/gim,"<h1>$1</h1>"),r=r.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>"),r=r.replace(/__(.+?)__/g,"<u>$1</u>"),r=r.replace(/\*(.+?)\*/g,"<em>$1</em>"),r=r.replace(/_(.+?)_/g,"<em>$1</em>"),r=r.replace(/~~(.+?)~~/g,"<del>$1</del>"),r=r.replace(/\[([^\]]+)\]\(([^\)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>'),r=r.replace(/\n/g,"<br/>"),r}static strip(d){return d.replace(/[#*_~\[\]()]/g,"").replace(/\n/g," ").trim()}}class ae{static encoder=new TextEncoder;static decoder=new TextDecoder;static async generateKey(d){const r=await window.crypto.subtle.importKey("raw",this.encoder.encode(d),{name:"PBKDF2"},!1,["deriveBits","deriveKey"]);return window.crypto.subtle.deriveKey({name:"PBKDF2",salt:this.encoder.encode("poeset-salt-v1"),iterations:1e5,hash:"SHA-256"},r,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}static async encrypt(d,r){try{const i=await this.generateKey(r),l=window.crypto.getRandomValues(new Uint8Array(12)),f=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:l},i,this.encoder.encode(d)),s=new Uint8Array(l.length+f.byteLength);return s.set(l),s.set(new Uint8Array(f),l.length),btoa(String.fromCharCode(...s))}catch(i){throw console.error("Encryption failed:",i),new Error("Failed to encrypt content")}}static async decrypt(d,r){try{const i=await this.generateKey(r),l=Uint8Array.from(atob(d),u=>u.charCodeAt(0)),f=l.slice(0,12),s=l.slice(12),m=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:f},i,s);return this.decoder.decode(m)}catch(i){throw console.error("Decryption failed:",i),new Error("Failed to decrypt content - wrong password?")}}}const qe=({poem:c,onSave:d,onClose:r,initialDate:i})=>{const[l,f]=a.useState(c?.title||""),[s,m]=a.useState(c?.content||""),[u,S]=a.useState(c?.tags||[]),[N,U]=a.useState(""),[E,oe]=a.useState(c?.date.split("T")[0]||i||new Date().toISOString().split("T")[0]),[k,P]=a.useState(c?.moods||[]),[Z,se]=a.useState(!1),[W,ie]=a.useState(!1),[K,ce]=a.useState(!1),[le,R]=a.useState(!1),[B,L]=a.useState(""),[de,V]=a.useState(!1),[z,ue]=a.useState(!1),[C,G]=a.useState(c?.isEncrypted||!1),[pe,T]=a.useState(!1),[$,A]=a.useState(""),[b,M]=a.useState(!1),I=a.useRef(null),D=a.useRef(c?.id||""),x=a.useRef(null),[g,ye]=a.useState(fe()),{t:v}=be(),{notify:w}=xe(),_=a.useMemo(()=>"webkitSpeechRecognition"in window||"SpeechRecognition"in window,[]),q=()=>{const t=B.trim();if(!t)return;const n=g.customMoods||[];if(n.includes(t)||re.includes(t))return;const o=[...n,t],y={...g,customMoods:o};ke(y),ye(y),P(p=>[...p,t]),L(""),R(!1)},X=a.useMemo(()=>{if(!N)return[];const t=we(),n=new Set;return t.forEach(o=>{o.tags.forEach(y=>n.add(y))}),Array.from(n).filter(o=>o.toLowerCase().includes(N.toLowerCase())&&!u.includes(o)).slice(0,5)},[N,u]);a.useEffect(()=>{D.current||(D.current=`poem-${Date.now()}-${Math.random().toString(36).substr(2,9)}`)},[]),a.useEffect(()=>{if(!_)return;const t=window.webkitSpeechRecognition||window.SpeechRecognition,n=new t;return n.continuous=!0,n.interimResults=!0,n.lang=g.language==="pl"?"pl-PL":"en-US",n.onresult=o=>{let y="";for(let p=o.resultIndex;p<o.results.length;p++){const j=o.results[p][0].transcript;o.results[p].isFinal&&(y+=j+" ")}y&&m(p=>p+y)},n.onerror=o=>{M(!1),o.error==="not-allowed"||o.error==="denied"?w("Brak uprawnień do mikrofonu lub mikrofon zablokowany.","error"):o.error==="no-speech"?w("Nie wykryto mowy. Spróbuj ponownie.","warning"):w("Błąd rozpoznawania mowy: "+o.error,"error")},n.onend=()=>{if(b)try{n.start()}catch{M(!1)}},x.current=n,()=>{x.current&&x.current.stop()}},[g.language]),a.useEffect(()=>()=>{x.current&&(x.current.stop(),M(!1))},[]);const me=a.useCallback(()=>{if(!_){w("Twoja przeglądarka nie obsługuje rozpoznawania mowy.","warning");return}if(x.current)if(b)x.current.stop(),M(!1);else try{x.current.start(),M(!0)}catch{M(!1),w("Nie można uruchomić rozpoznawania mowy.","error")}},[b,_,w]);a.useEffect(()=>{if(s.trim())return I.current&&clearTimeout(I.current),I.current=window.setTimeout(()=>{const t=new Date().toISOString(),n={id:D.current,title:l.trim()||"Bez tytułu",content:s.trim(),date:`${E}T${new Date().toISOString().split("T")[1]}`,tags:u,moods:k,collectionIds:c?.collectionIds||[],createdAt:c?.createdAt||t,updatedAt:t};ee(n),V(!0),setTimeout(()=>V(!1),2e3)},3e3),()=>{I.current&&clearTimeout(I.current)}},[l,s,u,k,E,c]);const Y=a.useCallback(()=>{if(!s.trim())return;const t=new Date().toISOString(),n={id:D.current,title:l.trim()||"Bez tytułu",content:s.trim(),date:`${E}T${new Date().toISOString().split("T")[1]}`,tags:u,moods:k,collectionIds:c?.collectionIds||[],createdAt:c?.createdAt||t,updatedAt:t};ee(n),d(n)},[s,l,E,u,k,c,d]),O=t=>{const n=(t||N).trim();n&&!u.includes(n)&&(S([...u,n]),U(""))},ge=t=>{S(u.filter(n=>n!==t))},F=t=>{const n=document.querySelector("textarea");if(!n)return;const o=n.selectionStart,y=n.selectionEnd,p=s.substring(o,y);if(!p)return;let j="";switch(t){case"bold":j=`**${p}**`;break;case"italic":j=`*${p}*`;break;case"underline":j=`__${p}__`;break}const he=s.substring(0,o)+j+s.substring(y);m(he),setTimeout(()=>{n.focus(),n.setSelectionRange(o,o+j.length)},0)},J=async()=>{if($.trim())try{const t=await ae.encrypt(s,$);m(t),G(!0),T(!1),A("")}catch{w("Błąd szyfrowania","error")}},Q=async()=>{if($.trim())try{const t=await ae.decrypt(s,$);m(t),G(!1),T(!1),A("")}catch{w("Nieprawidłowe hasło","error")}};return Fe([{key:"s",ctrlKey:!0,callback:Y,description:"Save (Ctrl+S)"},{key:"Escape",callback:r,description:"Close (Esc)"}]),e.jsxs("div",{style:{position:"fixed",background:"var(--bg-primary)",zIndex:1e3,display:"flex",flexDirection:"column",border:"2px solid var(--accent-color)",boxShadow:"0 8px 32px rgba(0,0,0,0.18)",borderRadius:"1.5rem",margin:"2vw",overflow:"hidden",maxWidth:"700px",maxHeight:"95vh",left:"50%",top:"50%",transform:"translate(-50%, -50%)"},children:[e.jsxs("div",{style:{padding:"var(--spacing-md)",borderBottom:"1px solid var(--border-color)",display:"flex",justifyContent:"space-between",alignItems:"center",background:"var(--bg-secondary)"},children:[e.jsx("button",{className:"button button-secondary",onClick:r,style:{padding:"0.5rem"},children:e.jsx(H,{size:20})}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem",alignItems:"center"},children:[de&&e.jsx("span",{style:{fontSize:"0.75rem",color:"var(--text-secondary)",marginRight:"0.5rem"},children:"✓ Zapisano"}),g.enableMarkdown&&e.jsx("button",{className:"button button-secondary",onClick:()=>ue(!z),style:{padding:"0.5rem"},title:z?"Ukryj podgląd":"Pokaż podgląd Markdown",children:z?e.jsx(Te,{size:20}):e.jsx(ve,{size:20})}),_&&e.jsxs("button",{className:`button ${b?"button-primary":"button-secondary"}`,onClick:me,style:{padding:"0.5rem",position:"relative"},title:b?"Zatrzymaj dyktowanie":"Rozpocznij dyktowanie",children:[b?e.jsx(ne,{size:20}):e.jsx(Ke,{size:20}),b&&e.jsx("span",{style:{position:"absolute",top:2,right:2,width:10,height:10,borderRadius:"50%",background:"red",animation:"blink 1s infinite",boxShadow:"0 0 6px 2px rgba(255,0,0,0.3)"}})]}),!_&&e.jsx("button",{className:"button button-secondary",style:{padding:"0.5rem",opacity:.5,cursor:"not-allowed"},title:"Twoja przeglądarka nie obsługuje rozpoznawania mowy",disabled:!0,children:e.jsx(ne,{size:20})}),e.jsx("button",{className:"button button-secondary",onClick:()=>se(!Z),style:{padding:"0.5rem"},children:e.jsx(Se,{size:20})}),e.jsx("button",{className:`button ${C?"button-primary":"button-secondary"}`,onClick:()=>T(!0),style:{padding:"0.5rem"},title:C?"Wiersz zaszyfrowany":"Zaszyfruj wiersz",children:e.jsx(Pe,{size:20})}),e.jsx("button",{className:`button ${K?"button-primary":"button-secondary"}`,onClick:()=>ce(!K),style:{padding:"0.5rem"},title:"Nastrój wiersza",children:e.jsx(Be,{size:20})}),e.jsx("button",{className:"button button-secondary",onClick:()=>ie(!W),style:{padding:"0.5rem"},children:e.jsx(Ne,{size:20})}),e.jsxs("button",{className:"button button-primary",onClick:Y,disabled:!s.trim(),children:[e.jsx(je,{size:20}),"Zapisz"]})]})]}),Z&&e.jsxs("div",{style:{padding:"var(--spacing-md)",borderBottom:"1px solid var(--light-border)",position:"relative"},children:[e.jsxs("div",{style:{display:"flex",gap:"0.5rem",marginBottom:"0.5rem"},children:[e.jsxs("div",{style:{position:"relative",flex:1},children:[e.jsx("input",{type:"text",className:"input",placeholder:"Dodaj tag...",value:N,onChange:t=>U(t.target.value),onKeyPress:t=>t.key==="Enter"&&O(),style:{padding:"0.5rem",width:"100%"}}),X.length>0&&e.jsx("div",{style:{position:"absolute",top:"100%",left:0,right:0,marginTop:"0.25rem",background:"var(--bg-primary)",border:"1px solid var(--border-color)",borderRadius:"0.5rem",boxShadow:"0 4px 6px rgba(0, 0, 0, 0.1)",zIndex:1e3,maxHeight:"200px",overflowY:"auto"},children:X.map(t=>e.jsx("div",{onClick:()=>O(t),style:{padding:"0.75rem",cursor:"pointer",borderBottom:"1px solid var(--border-color)",fontSize:"0.875rem"},onMouseEnter:n=>{n.currentTarget.style.background="var(--bg-secondary)"},onMouseLeave:n=>{n.currentTarget.style.background="transparent"},children:t},t))})]}),e.jsx("button",{className:"button button-primary",onClick:()=>O(),children:"Dodaj"})]}),u.length>0&&e.jsx("div",{style:{display:"flex",gap:"0.5rem",flexWrap:"wrap"},children:u.map(t=>e.jsxs("span",{style:{fontSize:"0.875rem",padding:"0.25rem 0.75rem",borderRadius:"var(--radius-full)",background:"var(--light-border)",display:"flex",alignItems:"center",gap:"0.5rem",cursor:"pointer"},onClick:()=>ge(t),children:[t," ",e.jsx(H,{size:14})]},t))})]}),K&&e.jsxs("div",{style:{padding:"var(--spacing-md)",borderBottom:"1px solid var(--light-border)"},children:[e.jsx("label",{style:{display:"block",fontSize:"0.875rem",marginBottom:"0.5rem",opacity:.7},children:v.filters.mood}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(140px, 1fr))",gap:"0.5rem"},children:[e.jsx("button",{className:`button ${k.length===0?"button-primary":"button-secondary"}`,onClick:()=>P([]),style:{fontSize:"0.875rem"},children:v.poems.allMoods}),re.map(t=>e.jsx("button",{className:`button ${k.includes(t)?"button-primary":"button-secondary"}`,onClick:()=>P(n=>n.includes(t)?n.filter(o=>o!==t):[...n,t]),style:{fontSize:"0.875rem"},children:v.mood&&v.mood[t]?v.mood[t]:t},t)),(g.customMoods||[]).map(t=>e.jsx("button",{className:`button ${k.includes(t)?"button-primary":"button-secondary"}`,onClick:()=>P(n=>n.includes(t)?n.filter(o=>o!==t):[...n,t]),style:{fontSize:"0.875rem"},children:t},t))]}),e.jsx("div",{style:{marginTop:"var(--spacing-md)",borderTop:"1px solid var(--light-border)",paddingTop:"var(--spacing-md)"},children:le?e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsx("input",{type:"text",className:"input",value:B,onChange:t=>L(t.target.value),onKeyPress:t=>t.key==="Enter"&&q(),placeholder:v.editor?.moodPlaceholder||"Nazwa nastroju...",style:{flex:1,padding:"0.5rem"},autoFocus:!0}),e.jsx("button",{className:"button button-primary",onClick:q,disabled:!B.trim(),style:{padding:"0.5rem"},children:e.jsx(te,{size:18})}),e.jsx("button",{className:"button button-secondary",onClick:()=>{R(!1),L("")},style:{padding:"0.5rem"},children:e.jsx(H,{size:18})})]}):e.jsxs("button",{className:"button button-secondary",onClick:()=>R(!0),style:{fontSize:"0.875rem",display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(te,{size:16}),v.editor?.addCustomMood||"Dodaj własny nastrój"]})})]}),W&&e.jsx("div",{style:{padding:"var(--spacing-md)",borderBottom:"1px solid var(--light-border)"},children:e.jsx("input",{type:"date",className:"input",value:E,onChange:t=>oe(t.target.value),style:{padding:"0.5rem"}})}),pe&&e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0,0,0,0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},onClick:()=>T(!1),children:e.jsxs("div",{style:{background:"var(--bg-primary)",padding:"var(--spacing-lg)",borderRadius:"0.5rem",maxWidth:"400px",width:"90%"},onClick:t=>t.stopPropagation(),children:[e.jsx("h3",{style:{marginBottom:"var(--spacing-md)"},children:C?"Odszyfruj wiersz":"Zaszyfruj wiersz"}),e.jsx("input",{type:"password",className:"input",placeholder:"Hasło",value:$,onChange:t=>A(t.target.value),onKeyPress:t=>t.key==="Enter"&&(C?Q():J()),style:{marginBottom:"var(--spacing-md)"}}),e.jsxs("div",{style:{display:"flex",gap:"var(--spacing-sm)"},children:[e.jsx("button",{className:"button button-primary",onClick:C?Q:J,style:{flex:1},children:C?"Odszyfruj":"Zaszyfruj"}),e.jsx("button",{className:"button button-secondary",onClick:()=>{T(!1),A("")},style:{flex:1},children:"Anuluj"})]})]})}),e.jsxs("div",{style:{flex:1,padding:"var(--spacing-xl)",overflow:"auto",display:z&&g.enableMarkdown?"grid":"block",gridTemplateColumns:z&&g.enableMarkdown?"1fr 1fr":"1fr",gap:"var(--spacing-lg)"},children:[e.jsxs("div",{children:[e.jsx("input",{type:"text",className:"input font-serif",placeholder:"Tytuł (opcjonalny)",value:l,onChange:t=>f(t.target.value),style:{fontSize:"1.5rem",fontWeight:500,marginBottom:"var(--spacing-lg)",border:"none",padding:"0"}}),e.jsxs("div",{style:{display:"flex",gap:"0.25rem",marginBottom:"var(--spacing-md)",paddingBottom:"var(--spacing-sm)",borderBottom:"1px solid var(--light-border)"},children:[e.jsx("button",{className:"button button-secondary",onClick:()=>F("bold"),style:{padding:"0.5rem",fontSize:"0.875rem"},title:"Pogrubienie (zaznacz tekst)",children:e.jsx(Ce,{size:16})}),e.jsx("button",{className:"button button-secondary",onClick:()=>F("italic"),style:{padding:"0.5rem",fontSize:"0.875rem"},title:"Kursywa (zaznacz tekst)",children:e.jsx(Ie,{size:16})}),e.jsx("button",{className:"button button-secondary",onClick:()=>F("underline"),style:{padding:"0.5rem",fontSize:"0.875rem"},title:"Podkreślenie (zaznacz tekst)",children:e.jsx(Oe,{size:16})}),e.jsx("span",{style:{fontSize:"0.75rem",color:"var(--text-secondary)",display:"flex",alignItems:"center",marginLeft:"0.5rem"},children:"Zaznacz tekst i kliknij aby sformatować"})]}),e.jsx("textarea",{className:"input textarea font-serif",placeholder:"Zacznij pisać wiersz...",value:s,onChange:t=>m(t.target.value),style:{border:"none",padding:"0",fontSize:"1.125rem",lineHeight:1.8,minHeight:"400px",background:b?"rgba(255,0,0,0.04)":void 0},autoFocus:!0})]}),z&&g.enableMarkdown&&e.jsxs("div",{style:{borderLeft:"2px solid var(--light-border)",paddingLeft:"var(--spacing-lg)"},children:[e.jsx("h3",{style:{fontSize:"1.5rem",fontWeight:500,marginBottom:"var(--spacing-lg)",opacity:.7},children:l||"Bez tytułu"}),e.jsx("div",{className:"markdown-preview",style:{fontSize:"1.125rem",lineHeight:1.8,whiteSpace:"pre-wrap"},dangerouslySetInnerHTML:{__html:He.parse(s)}})]})]})]})};export{re as D,He as M,qe as P,Fe as u};
